name: Check Version
on:
  workflow_dispatch:
  pull_request:

jobs:
  check-version:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v3
      - name: Install yq
        run: sudo snap install yq
      - name: Compare versions
        run: |
          SNAP_VERSION=$(yq .version snap/snapcraft.yaml)
          sudo adduser "$USER" lxd
          sg lxd -c "lxd waitready"
          sg lxd -c "lxd init --auto"
          sg lxd -c "lxc launch ubuntu:22.04 temp"
          sg lxd -c "lxc exec temp -- apt-get update"
          APT_VERSION=$(sg lxd -c "lxc exec temp -- apt-cache show mysql-server-8.0 | grep Version | head -n 1 | cut -c10-")
          APT_VERSION=${APT_VERSION::-17}
          sg lxd -c "lxc stop temp && lxc rm temp"
          if [ "$SNAP_VERSION" != "$APT_VERSION" ]; then
              echo "VERSION MISMATCH DETECTED"
              echo "Snap version: $SNAP_VERSION"
              echo "APT version: $APT_VERSION"
              exit 1
          fi
